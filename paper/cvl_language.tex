% !TEX root = ./cvl.tex
\section{CVL language}
\label{sec:cvl-language}
CVL is a declarative language for generalizing a spatial dataset. It is designed to be very concise, typically no more than ten lines of code, and to be usable by non-cartographers. The language has only two statements, the \emph{generalize} statement and the \emph{create constraint} statement. 



The create constraint statement is use to augment CVL with new cartographic constraints.

\subsection{Generalize statement}
The generalize statement is used to transform an input spatial dataset to a multi-scale output dataset, which is well-suited for display on a zoomable map such as the web maps that have gained immense popularity over the last ten years. The generalize statement has several clauses, some of which are mandatory. 

\subsubsection{input-output clause}

The \emph{input-output} clause is mandatory. It is parameterized by the names of input and output datasets, and the record fields holding the ID and geometry data. The clause has the following syntax:

\begin{lstlisting}
GENERALIZE 
   {input} TO {output}
WITH ID
   {field}
WITH GEOMETRY 
   {field}
\end{lstlisting}

Optionally the user may use the \emph{with-other} sub-clause to list additional fields that should be copied from input to output. If this part is omitted, only the ID and geometry field are copied to the output:

\begin{lstlisting}
WITH OTHER {list of fields}
\end{lstlisting}

\subsubsection{zoom-levels clause}

The \emph{zoom-levels} clause is mandatory. It is parameterized by a positive integer which is the number of zoom-levels that the input should be generalized for. Zoom-levels run from 1 (lowest scale) to some positive integer $\mathcal{Z}$ (largest scale) typically less than the number 20. The clause has the following syntax:

\begin{lstlisting}
AT {integer} ZOOM LEVELS
\end{lstlisting}

\subsubsection{rank-by clause}

The \emph{rank by} clause is optional. It is used to differentiate between "important" and "unimportant" records. It is parameterized by an expression that evaluates to a floating point number. The expression is anything that could occur in an SQL select clause. An example is a call to the \texttt{random()} function in SQL. If the clause is left out, records are ranked by the constant $1$. This clause has the following syntax:

\begin{lstlisting}
RANK BY {float expr}
\end{lstlisting}

\subsubsection{partition-by clause}

The \emph{partition by} clause is optional. It is used to split the input into partitions which are generalized separately by the CVL system. It is parameterized by a scalar expression, which can be any expression that could occur in an SQL select clause. An example is the name of a field in the input, which can be used to partition the data. Partitions are treated separately by the CVL interpreter. If no clause is given, all records are partitioned by the constant $1$. 

\begin{lstlisting}
PARTITION BY
   {scalar expr}
\end{lstlisting}

\subsubsection{merge-partitions clause}

The \emph{merge-partitions} clause is optional, but requires the \emph{partition-by} clause to be also present. It is used to combine several partitions produced by the partition-by clause into a single partition. This is useful if some partitions contains very little data. It is parameterized by a list of tuples. The first tuple-element is a list of partitions created using the partition-by clause. The second tuple-element is a scalar value to use as the new partition value. A special wild-card partition name can be used to group any remaining partitions into a single partition.

\begin{lstlisting}
MERGE PARTITIONS    
    {partitions} AS {scalar expr}
AND 
   {partitions} AS {scalar expr}]
...
AND 
   * AS {scalar expr}
\end{lstlisting}

\subsubsection{subject-to clause}

The \emph{subject-to} clause is arguably the most important one, but is also optional. A list of cartographic constraints (see Section~\ref{sec:cartographic-constraints}) are given to which the output must conform. The constraints must hold for each partition and for every zoom-level. Constraint are listed with a constraint name followed by a list of float-valued parameters. Constraints are created using the \emph{create-constraint} statement (see Section~\ref{sec:create-constraint-statement}).

\begin{lstlisting}
SUBJECT TO 
   {constraint} {float parameters} 
AND
   {constraint} {float parameters}
...
\end{lstlisting}

\subsubsection{force-level clause}

The user may optionally choose to manually override the constraint mechanism for selected partitions. Using the \emph{force-level} clause a minimum zoom-level can be set for a given partition. Constraints are not evaluated for these partitions:

\begin{lstlisting}
FORCE MIN LEVEL
   {integer} FOR {partition}
AND
   {integer} FOR {partition}
...
\end{lstlisting}

\subsubsection{all-or-nothing clause}

Finally, the user may optionally use the \emph{all-or-nothing} clause to ensure that either all records in a partition are visible at a given zoom-level or none of them are.

\begin{lstlisting}
ALLORNOTHING
\end{lstlisting}

\subsection{Create constraint statement}
\label{sec:create-constraint-statement}

The basic statement for creating cartographic constraints is:

\begin{lstlisting}
CREATE CONSTRAINT C1 AS
SELECT cid, rid
  {user-defined SQL}
RESOLVE IF {exp}
\end{lstlisting}

For practical purposes this is extended with optional \emph{setup} and \emph{cleanup} sub-clauses. These are executed before and after the constraint is executed. The full syntax for the \emph{create-constraint} statement becomes:

\begin{lstlisting}
CREATE CONSTRAINT C1 AS
SELECT cid, rid
  {user-defined SQL}
RESOLVE IF {exp}
WITH SETUP
  {user-defined SQL}
WITH CLEANUP
  {user-defined SQL}
\end{lstlisting}

\subsection{CVL framework functions}

Some utility functions are given by the CVL framework. The aim of these functions is to make it easier to write constraints. The functions are:

\begin{description}
\item [CellSizeZ] yada yada
\item [ResolutionZ] yada yada
\item [PointHash] yada yada
\item [WebMercatorCells:] Takes as input a geometry and a zoom-level. Produces a set of points that correspond to the centers of intersected cells in standard Web Mercator tile model~\cite{osm?} at the given zoom-level.
\end{description}


\subsection{Examples of CVL}

TODO
